# Cloud Speech API 3 Ways: Challenge Lab

## Task 1. Create an API key

1. To create an API key, in the Navigation menu (Navigation menu icon), click APIs & services > Credentials.
2. Click +CREATE CREDENTIALS.
3. In the drop down menu, select API key.
4. Copy the key you just generated.
5. Run the following in Cloud Shell. Be sure to replace <your_api_key> with the key you just copied:

```bash
export API_KEY=your_api_key
```

## Task 2. Create synthetic speech from text using the Text-to-Speech API

### Enable the Text-to-Speech API

1. In the Navigation menu (Navigation menu icon), click APIs and Services > Library.
2. Enter text-to-speech in the Search for APIs & Services box, then click Cloud Text-to-Speech API from the search results.
3. Click Enable to enable the Cloud Text-to-Speech API.

### Create or Activate Environment

1. Install the virtualenv environment: `sudo apt-get install -y virtualenv`
2. Build the virtual environment: `python3 -m venv venv`
3. Activate the virtual environment: `source venv/bin/activate`

### Create a service account

1. Run the following command in Cloud Shell: `gcloud iam service-accounts create tts-qwiklab`
2. Generate a key to use that service account: `gcloud iam service-accounts keys create tts-qwiklab.json --iam-account tts-qwiklab@<thay-project-id>.iam.gserviceaccount.com`
3. Generate a key to use that service account: `export GOOGLE_APPLICATION_CREDENTIALS=tts-qwiklab.json`

Note:
`tts-qwiklab.json` tạo ở cloud shell cần download về máy local, xong upload lên instance hoặc thực hiện lệnh sau trong cloud shell:

```
gcloud compute scp tts-qwiklab.json <thay-vm-name>:~ --zone=<zone của vm>
```

### Call the Text-to-Speech API to synthesize the text of the synthesize-text.json file, and store the result in a file named <challenge lab name>.

`nano synthesize-text.json` xong copy text sau và quit

```
{
    'input':{
        'text':'Cloud Text-to-Speech API allows developers to include
           natural-sounding, synthetic human speech as playable audio in
           their applications. The Text-to-Speech API converts text or
           Speech Synthesis Markup Language (SSML) input into audio data
           like MP3 or LINEAR16 (the encoding used in WAV files).'
    },
    'voice':{
        'languageCode':'en-gb',
        'name':'en-GB-Standard-A',
        'ssmlGender':'FEMALE'
    },
    'audioConfig':{
        'audioEncoding':'MP3'
    }
}
```

request:

```
curl -H "Authorization: Bearer "$(gcloud auth application-default print-access-token) \
  -H "Content-Type: application/json; charset=utf-8" \
  -d @synthesize-text.json "https://texttospeech.googleapis.com/v1/text:synthesize" \
  > <thay ten o day>
```

### Generate audio file

`vim tts_decode.py`, gõ ": set paste" để bật paste mode hoặc dùng nano, copy & paste nội dung sau

```
import argparse
from base64 import decodebytes
import json

"""
Usage:
        python tts_decode.py --input "Filled in at lab start" \
        --output "synthesize-text-audio.mp3"

"""

def decode_tts_output(input_file, output_file):
    """ Decode output from Cloud Text-to-Speech.

    input_file: the response from Cloud Text-to-Speech
    output_file: the name of the audio file to create

    """

    with open(input_file) as input:
        response = json.load(input)
        audio_data = response['audioContent']

        with open(output_file, "wb") as new_file:
            new_file.write(decodebytes(audio_data.encode('utf-8')))

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description="Decode output from Cloud Text-to-Speech",
        formatter_class=argparse.RawDescriptionHelpFormatter)
    parser.add_argument('--input',
                       help='The response from the Text-to-Speech API.',
                       required=True)
    parser.add_argument('--output',
                       help='The name of the audio file to create',
                       required=True)

    args = parser.parse_args()
    decode_tts_output(args.input, args.output)
```

Thực thi `python tts_decode.py --input "synthesize-text.txt" --output "synthesize-text-audio.mp3"`

## Task 3. Perform speech to text transcription with the Cloud Speech API

1. SSH vào vm, sử dụng API Key ở task 1, `export API_KEY=...`
2. `vim request-ten-theo-lab.json` then paste

```
{
  "config": {
    "encoding":"FLAC",
    "languageCode": "fr"
  },
  "audio": {
    "uri":"gs://cloud-samples-data/speech/corbeau_renard.flac"
  }
}
```

3. Send request

```
curl -s -X POST -H "Content-Type: application/json" --data-binary @request-ten-theo-lab.json \
"https://speech.googleapis.com/v1/speech:recognize?key=${API_KEY}" > result-ten-theo-lab.json
```

## Task 4. Translate text with the Cloud Translation API

```
export TEXT=<text o bai lab>
export OUTPUT=<ten file output>
curl "https://translation.googleapis.com/language/translate/v2?target=en&key=${API_KEY}&q=${TEXT}" > $OUTPUT
```

## Task 5. Detect a language with the Cloud Translation API

```
export TEXT="text o bai lab"
export OUTPUT=<ten file out>
curl -X POST "https://translation.googleapis.com/language/translate/v2/detect?key=${API_KEY}" -d "q=${TEXT}" > $OUTPUT
```

**Note** có thể bỏ `> $OUTPUT` để xem kết quả
